<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-search/paper-search-bar.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">

<!-- GENERATOR for all lists the same -->

<dom-module id="animad-list-header">
    <template>
      <style></style>

      <div hidden$="[[hideHeader]]">
				<paper-item id="search-panel">
          <paper-dropdown id="filter-field"
              hidden$="[[_hideFilterButton(searchFilters)]]"
              on-selected-changed="_changeSearch"
              label="[[placeholderFilter]]"
              value="{{selectedSearch}}"
              searchable="true"
              disabled="[[readonly]]"
              multi="true"
              multi-label="[[placeholderSelection]]"
              >
              <!--in paper-dropdown ergänzen, sobald pull request durch ist-->
              <!--multi-label="[[t('items-selected')]]"-->
              <template is="dom-repeat" items="{{searchFilters}}">
                  <paper-item value$="[[item.query]]">[[item.label]]</paper-item>
              </template>
          </paper-dropdown>

		      <paper-item-body>
		    		<paper-search-bar
		    			id="search-bar"
		    			class="search"
		    			icon="[[icon]]"
		    			placeholder="[[placeholderSearch]]"
		    			hide-filter-button="[[_hideFilterButton(allFilters)]]"
		    			disable-filter-button="[[_disableFilterButton(allFilters)]]"
		    			query="{{search}}"
		    			nr-selected-filters="[[_nrSelectedFilters]]"
		    			on-paper-search-filter="_toggleFilterSelectionOpen"
              on-paper-search-search="_onSearchRequest">
		    		</paper-search-bar>
		      </paper-item-body>

          <paper-button id="new-button"
            raised
            on-tap="_onNew"
            disabled="[[disableNewButton]]"
            hidden="[[hideNewButton]]">
              [[placeholderNew]]
          </paper-button>
		      <paper-button id="delete-button"
            raised
            on-tap="_onDelete"
            disabled="[[disableDeleteButton]]"
            hidden="[[hideDeleteButton]]">
              [[placeholderDelete]]
          </paper-button>
		    </paper-item>

        <template is="dom-if" if="[[showResults]]">
    			<div>{{resultsText}}</div>
    		</template>

		    <iron-collapse id="filter-selection" opened=[[_isFilterSelectionOpen]]>
		      <template is="dom-repeat" items="{{allFilters}}" as="allFilters">
		        <div>
		          [[allFilters.id]]
		          <template is="dom-repeat" items="{{allFilters.filters}}" as="filter">
		            <div>
		              <paper-checkbox on-tap="_onFilter" data-filtertype$="[[allFilters.id]]" data-filter$="[[filter]]">[[filter.label]]</paper-checkbox>
		            </div>
		          </template>
		        </div>
		      </template>
		    </iron-collapse>
      </div>
    </template>
    <script>

      /**
       * `animad-list-header` wird in den Listen als Header der Animad-Applikation angezeigt.
       *
       * Das Element bietet die Möglichkeit Suche- und Filter-Eingaben für die Liste zu setzen,
       * selektierbare Filter anzuzeigen und
       * Events zur Navigation auf Formular-Seiten und zur Ausführung von Lösch- und Suchfunktionen anzustossen.
       *
       * #### Beispiel:
       *
       *     <animad-list-header
       *         id="animad-list-header-filter"
       *         placeholder-search="[[$t('filter_placeholder')]]"
       *         placeholder-delete="Löschen"
       *         placeholder-new="Neu"
       *         all-filters="[[_localizedFilters]]"
       *         selected-filters = "{{_selectedFilters}}"
       *         search="{{_filterString}}"
       *         on-filter="_filterData"
       *         on-filter-selection="_filterSelectionData"
       *         on-delete="_confirmDeleteSelected"
       *         on-new="_handleNew"
       *         disable-delete-button="[[_disableDeleteButton]]"
       *         hide-header="[[_hideFilterHeader(hideHeader)]]"
       *         hide-new-button="[[hideNew]]"
       *         hide-delete-button="[[hideDelete]]"
       *         hide-filter-button="[[hideFilter]]"
       *         disable-filter-button="[[disableFilter]]"
       *         disable-new-button="[[disableNew]]"
       *         show-results="[[showResults]]"
       *         results-text="[[_resultsText]]"
       *         icon="[[icon]]">
       *     </animad-list-header>
       *
       * @customElement
       * @polymer
       **/
        class AnimadListHeader extends Polymer.Element {
            static get is() { return 'animad-list-header'; }

            /**
            * @event delete
            *
            * Ausgelöst, wenn der Löschen-Button geklickt wird.
            */
            /**
            * @event new
            *
            * Ausgelöst, wenn der Neu-Button geklickt wird.
            */
            /**
            * @event search
            *
            * Ausgelöst, wenn im Suche-Feld die Enter-Taste betätigt wird.
            */
            /**
            * @event filter
            *
            * Ausgelöst, wenn im Filter-Feld eine Eingabe gemacht wird.
            */
            /**
            * @event filter-selection
            *
            * Ausgelöst, wenn ein selektierbarer Filter selektiert oder deselektiert wird.
            */
            static get properties() {
                return {
									/*
				    			 * Eingabewert im Suche-Feld
				    			 */
				    			search: {
				    				type: String,
				    				observer: '_onChangeRequest',
				    				notify: true
				    			},
                  /*
                   */
                  selectedSearch: {
                    type: String
                  },
                  /*
				          * `selectedFilters` enthält die Information über alle ausgewählten selektierbaren Filter.
				          */
				          selectedFilters: {
				            type: Array,
				            value() {
				              return [];
				            }
				          },
				    			/*
				    			 * Alle selektierbaren Filter, die ausgewählt werden können.
				    			 */
				    			allFilters: Object,
                  /*
				    			 * Alle selektierbaren Filter, die ausgewählt werden können.
				    			 */
				    			searchFilters: Object,
                  /*
                  * Gibt an, ob der Header angezeigt werden soll oder nicht.
                  * Ist das Attribut "hide-header" gesetzt, wird der Header nicht angezeigt.
                  */
                  hideHeader: Boolean,
                  /*
                  * Gibt an, ob der Filter-Button angezeigt werden soll oder nicht.
                  * Ist das Attribut "hide-filter-button" gesetzt, wird der Filter-Button nicht angezeigt.
                  */
				    			hideFilterButton: {
				    				type: Boolean,
				    				value: false
				    			},
                  /*
                  * Gibt an, ob der Löschen-Button angezeigt werden soll oder nicht.
                  * Ist das Attribut "hide-delete-button" gesetzt, wird der Löschen-Button nicht angezeigt.
                  */
				    			hideDeleteButton: {
				    				type: Boolean,
				    				value: false
				    			},
                  /*
                  * Gibt an, ob der Neu-Button angezeigt werden soll oder nicht.
                  * Ist das Attribut "hide-new-button" gesetzt, wird der Neu-Button nicht angezeigt.
                  */
				    			hideNewButton: {
				    				type: Boolean,
				    				value: false
				    			},
                  /*
                  * Gibt an, ob der Filter-Button aktiviert oder deaktiviert werden soll.
                  * Ist das Attribut "disable-filter-button" gesetzt, wird der Filter-Button deaktiviert.
                  */
				    			disableFilterButton: {
				    				type: Boolean,
				    				value: false
				    			},
                  /*
                  * Gibt an, ob der Löschen-Button aktiviert oder deaktiviert werden soll.
                  * Ist das Attribut "disable-delete-button" gesetzt, wird der Löschen-Button deaktiviert.
                  */
				    			disableDeleteButton: {
				    				type: Boolean,
				    				value: false
				    			},
                  /*
                  * Gibt an, ob der Neu-Button aktiviert oder deaktiviert werden soll.
                  * Ist das Attribut "disable-new-button" gesetzt, wird der Neu-Button deaktiviert.
                  */
				    			disableNewButton: {
				    				type: Boolean,
				    				value: false
				    			},
                  /*
                  * Gibt an welches Icon im Suche-Hintergrund angezeigt werden soll.
                  */
				    			icon: {
				    				type: String,
				    				value: 'search'
				    			},
				    			/*
				    			 * Gibt den Text an, der im Suche-Feld angezeigt werden soll, solange dort keine Eingabe gemacht wurde.
				    			 */
				    			placeholderSearch: {
				    				type: String,
				    				value: 'Search'
				    			},
				    			/*
				    			 * Gibt den Text an, der auf dem Löschen-Button angezeigt wird.
				    			 */
				    			placeholderDelete: {
				    				type: String,
				    				value: 'Delete'
				    			},
                  /*
				    			 * Gibt den Text an, der auf dem Neu-Button angezeigt wird.
				    			 */
				    			placeholderNew: {
				    				type: String,
				    				value: 'New'
				    			},
                  /*
                   * Gibt den Text an, der auf dem Neu-Button angezeigt wird.
                   */
                  placeholderFilter: {
                    type: String,
                    value: 'Filter'
                  },
                  /*
                  */
                  placeholderSelection: {
                    type: String,
                    value: 'elements selected'
                  },
                  /*
                   * Wechselt die Sichtbarkeit des zusammenklappbaren Elements für die Filter-Selektion
                   */
				          _isFilterSelectionOpen: {
				            type: Boolean,
				            value: false
				          },
                  /*
                   * Gibt an, ob die Anzahl der gefundenen Datensätze angezeigt werden soll.
                   */
				          showResults: {
				            type: Boolean,
				            value: true
				          },
                  /*
                  * Gibt den Text an, der für die Anzahl der gefundenen Datensätze verwendet werden soll.
                  */
				          resultsText: {
				            type: String,
				            value: ''
				          }
                }
            }

            focus(){
              var searchBar =this.shadowRoot.querySelector('#search-bar');
              searchBar.focus();
            }

						// protected methods
            /*
            * Löst den Event `search` aus.
            */
            _onSearchRequest(event){
              this.dispatchEvent(new CustomEvent('search', {bubbles: true, composed: true}));
            }

            /*
            * Löst den Event `filter` aus.
            */
			  		_onChangeRequest(newValue, oldValue) {
			  			// Ignore initial setting of properties (caller is supposed to trigger this call automatically)
			  			if (typeof oldValue !== 'undefined') {
                this.dispatchEvent(new CustomEvent('filter', {bubbles: true, composed: true}));
			  			}
			  		}

            /*
            * Setzt die selektierten Filter und löst den Event `filter-selection` aus
            */
			      _onFilter(event) {
			        // get attribute ('data-') values from tapped checkbox
			        var filtertype = event.target.dataset.filtertype;
			        var filterString = event.target.dataset.filter;

			        // convert attribute filter string to filter object
			        var filterObject = JSON.parse(filterString);

			        // search for filter object in property allFilters
			        var allFiltersByType = this.allFilters.find(filter => filter.id === filtertype );
			        var selectedFilter = allFiltersByType.filters.find(type => type.id === filterObject.id);

			        // check wether the filter object exists in selectedFilters
			        var filterObject = {type: filtertype, filter: selectedFilter};
			        var index = this.selectedFilters.findIndex(selFilter => selFilter.type === filtertype && selFilter.filter === selectedFilter);
			        if (index != -1) {
			          // does exist so remove it from selectedFilters
			          this.splice('selectedFilters', index, 1);
			        }
			        else {
			          // doesn't exist so push it to selectedFilters
			          this.push('selectedFilters', filterObject);
			        }

			        // set number of filters selected
			        this._nrSelectedFilters = this.selectedFilters.length;

			        // send Event search to enable filtering
              this.dispatchEvent(new CustomEvent('filter-selection', {bubbles: true, composed: true}));
			      }

            /*
            * Löst den Event `delete` aus.
            */
			      _onDelete(event){
              this.dispatchEvent(new CustomEvent('delete', {bubbles: true, composed: true}));
			      }
            /*
            * Löst den Event `new` aus.
            */
			      _onNew(event) {
              this.dispatchEvent(new CustomEvent('new', {bubbles: true, composed: true}));
			      }
            /*
            * Wechselt die Sichtbarkeit des Elements zur Anzeige der selektierbaren Filter.
            */
			      _toggleFilterSelectionOpen() {
			  			this._isFilterSelectionOpen = !this._isFilterSelectionOpen;
			  		}
            /*
            * Setzt die Sichtbarkeit des Filter-Buttons
            */
			      _hideFilterButton(filters) {
			  			return this.hideFilterButton || !filters || filters.length === 0;
			  		}
            /*
            * Setzt die Aktivierung / Deaktivierung des Filter-Buttons
            */
			  		_disableFilterButton(filters) {
			        return this.disableFilterButton || !filters || filters.length === 0;
			  		}
            /*
            */
            _changeSearch(e) {
              // TBD: Search bauen
              /*
              var myRe =/(\w+:\w+)|(\w+:\"[^\"]*\")/g;
              var searchArray;
              while ((searchArray = myRe.exec(this.search)) !== null) {
                var searchEntry = searchArray[0];
                for (var item of this.searchFilters) {
                  if (searchEntry == item) {
                    console.log("exists");
                    for (var selected of this.selectedSearch) {
                      console.log("selected");
                    }
                  }
                }
              }
              */
              for (var item of this.selectedSearch) {
                if (this.search) {
                  this.search += " "+item;
                }
                else {
                  this.search = item;
                }
              }

            }
        }

        customElements.define(AnimadListHeader.is, AnimadListHeader);
    </script>
</dom-module>
